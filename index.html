<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</title>
    <style>
        :root { --main: #1e293b; --accent: #0284c7; --bg: #f8fafc; --white: #ffffff; --danger: #be123c; --success: #059669; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: #334155; }
        header { background: var(--main); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { width: 40px; height: 40px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .page { display: none; padding: 25px; }
        .page.active { display: block; }
        .table-container { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f5f9; padding: 12px; border: 1px solid #e2e8f0; font-size: 13px; color: var(--main); }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        input, select { width: 92%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; }
        input[readonly] { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-add { background: var(--main); color: white; margin-bottom: 15px; }
        .nav-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.3s; }
        .card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .auth-box { max-width: 400px; margin: 80px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; }
        .tab { flex: 1; padding: 10px; cursor: pointer; font-weight: bold; color: #94a3b8; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        #loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .total-row { background: #f8fafc; font-weight: bold; }
        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .storage-meter { font-size: 11px; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<div id="loader"><b>â³...</b></div>

<div id="authScreen" class="auth-box">
    <div class="logo-img" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 30px;">ğŸ“ˆ</div>
    <div class="tabs">
        <div id="loginTab" class="tab active" onclick="switchAuth(true)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div id="registerTab" class="tab" onclick="switchAuth(false)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
    </div>
    <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="margin-bottom:15px; width:100%;">
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:10px; width:100%;">
    <button class="btn btn-save" style="width:100%" onclick="processAuth()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="appScreen" style="display:none;">
    <header>
        <div style="display:flex; align-items:center; gap:12px;"><div class="logo-img">ğŸ“‰</div><h2 style="margin:0">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</h2></div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="storageDisplay" class="storage-meter" style="display: none;"> 0%</div>
            <span id="userDisplay" style="font-weight: bold;"></span>
            <button class="btn btn-save" onclick="syncToCloud()" style="background:var(--success)">Ø­ÙØ¸</button>
            <button class="btn btn-del" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div id="homePage" class="page active">
        <div class="nav-menu">
            <div class="card" onclick="openPage('accountsPage')"><h3>ğŸ“ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3></div>
            <div class="card" onclick="openPage('journalPage')"><h3>ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3></div>
            <div class="card" onclick="openPage('productsPage')"><h3>ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</h3></div>
            <div class="card" onclick="openPage('partnersPage')"><h3>ğŸ¤ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙˆÙ†</h3></div>
            <div class="card" onclick="openPage('trialPage')"><h3>âš–ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</h3></div>
            <div class="card" onclick="openPage('incomePage')" style="background: #f0fdf4;"><h3>ğŸ“Š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h3></div>
            <div class="card" onclick="openPage('balanceSheetPage')" style="background: #eff6ff;"><h3>ğŸ¦ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</h3></div>
        </div>
        <div style="text-align:center; color:#94a3b8; font-size:12px; margin-top:20px;">Ø¥Ø¹Ø¯Ø§Ø¯ : Ø£ Ù…Ø§ÙŠÙƒÙ„ Ù…Ø§Ù‡Ø±</div>
    </div>

    <div id="accountsPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="table-container">
            <h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3>
            <button class="btn btn-add" onclick="addAcc()">+ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="accountsBody"></tbody></table>
        </div>
    </div>

    <div id="journalPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="table-container">
            <button class="btn btn-add" onclick="addJ()">+ Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</button>
            <table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="journalBody"></tbody></table>
        </div>
    </div>

    <div id="productsPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="table-container">
            <button class="btn btn-add" onclick="addP()">+ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
            <table><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø±ØµÙŠØ¯ Ø£ÙˆÙ„</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="productsBody"></tbody></table>
        </div>
    </div>

    <div id="partnersPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="table-container">
            <h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙŠÙ† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</h3>
            <button class="btn btn-add" onclick="addPartnerInfo()">+ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø§Ù…Ù„</button>
            <table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ù…Ø¯ÙŠÙ† (+)</th><th>Ø¯Ø§Ø¦Ù† (-)</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="partnersBody"></tbody></table>
        </div>
    </div>

    <div id="trialPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="table-container">
            <table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th><th>Ø±ØµÙŠØ¯ Ù…</th><th>Ø±ØµÙŠØ¯ Ø¯</th></tr></thead><tbody id="trialBody"></tbody></table>
        </div>
    </div>

    <div id="incomePage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="table-container">
            <h2 style="text-align: center;">ğŸ“Š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h2>
            <table><tbody id="incomeBody"></tbody></table>
        </div>
    </div>

    <div id="balanceSheetPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="report-grid">
            <div class="table-container">
                <h3>Ø§Ù„Ø£ØµÙˆÙ„</h3>
                <table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="assetsBody"></tbody></table>
            </div>
            <div class="table-container">
                <h3>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h3>
                <table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="liabilitiesBody"></tbody></table>
            </div>
        </div>
    </div>
</div>

<datalist id="accList"></datalist>
<datalist id="partnerList"></datalist>

<script>
    const API_KEY = "$2a$10$tfM8AfsPvswuaB9YYIoLG.3VICcr.uKPaoLBSyAzAgur6UCXLDanC";
    const BIN_ID = "6979e970ae596e708ffd539d"; 
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    const FIXED_ACCOUNTS = ["Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", "Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†", "Ø§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ†"];
    const ACC_TYPES = ["Ø£ØµÙˆÙ„", "Ø§Ù„ØªØ²Ø§Ù…Ø§Øª", "Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©", "Ù…Ø¨ÙŠØ¹Ø§Øª", "ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª", "Ù…ØµØ±ÙˆÙØ§Øª", "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰", "Ù…ØµØ±ÙˆÙØ§Øª Ø§Ø®Ø±Ù‰", "ØºÙŠØ± Ø°Ù„Ùƒ"];

    let masterData = { users: {} }; 
    let currentUser = "";
    let currentPass = "";
    let userDB = { accounts: [], journal: [], products: [], partnersInfo: [] };

    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
    function updateStorageMeter() {
        const totalSize = JSON.stringify(masterData).length; 
        const limit = 100 * 1024; 
        const percent = ((totalSize / limit) * 100).toFixed(2);
        const display = document.getElementById('storageDisplay');
        
        if (currentUser === "Ù…Ø§ÙŠÙƒÙ„ Ù…Ø§Ù‡Ø±") {
            display.style.display = "block";
            display.innerText = `: ${percent}%`;
        } else {
            display.style.display = "none";
        }
        
        if (percent > 90) display.style.color = "#fda4af"; 
        else if (percent > 70) display.style.color = "#fbbf24"; 
        else display.style.color = "#34d399"; 
    }

    function switchAuth(mode) {
        document.getElementById('loginTab').classList.toggle('active', mode);
        document.getElementById('registerTab').classList.toggle('active', !mode);
    }

    async function processAuth() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const isLogin = document.getElementById('loginTab').classList.contains('active');
        if(!u || !p) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(URL, { headers: { "X-Master-Key": API_KEY } });
            const result = await res.json();
            masterData = result.record || { users: {} };
            if(!masterData.users) masterData.users = {};

            const uKey = u.toLowerCase();
            if(isLogin) {
                if(masterData.users[uKey] && masterData.users[uKey].password === p) {
                    currentUser = u; currentPass = p;
                    userDB = masterData.users[uKey].data || { accounts: [], journal: [], products: [], partnersInfo: [] };
                    initFixedAccounts(); startApp();
                } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); }
            } else {
                if(masterData.users[uKey]) return alert("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");
                masterData.users[uKey] = { password: p, data: { accounts: [], journal: [], products: [], partnersInfo: [] } };
                currentUser = u; currentPass = p;
                userDB = masterData.users[uKey].data;
                initFixedAccounts();
                await syncToCloud();
                startApp();
            }
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); }
        document.getElementById('loader').style.display = 'none';
        updateStorageMeter();
    }

    async function syncToCloud() {
        document.getElementById('loader').style.display = 'flex';
        if (!masterData.users) masterData.users = {};
        masterData.users[currentUser.toLowerCase()] = { password: currentPass, data: userDB };
        
        try {
            const res = await fetch(URL, {
                method: 'PUT',
                headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                body: JSON.stringify(masterData)
            });
            if(res.ok) {
                alert("âœ… ");
                updateStorageMeter();
            }
        } catch (e) { alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸  "); }
        document.getElementById('loader').style.display = 'none';
    }

    function initFixedAccounts() {
        if(!userDB.accounts) userDB.accounts = [];
        if(!userDB.partnersInfo) userDB.partnersInfo = [];
        FIXED_ACCOUNTS.forEach(accName => {
            if(!userDB.accounts.find(a => a.name === accName)) {
                let type = (accName === "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†" || accName === "Ø§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ†") ? 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª' : 'Ø£ØµÙˆÙ„';
                userDB.accounts.push({name: accName, type: type, fixed: true});
            }
        });
    }

    function startApp() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        document.getElementById('userDisplay').innerText = "ğŸ‘¤ " + currentUser;
        updateDatalists();
        updateStorageMeter();
        openPage('homePage');
    }

    function logout() { location.reload(); }

    function openPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        render(id);
    }

    function updateDatalists() {
        const dl = document.getElementById('accList');
        dl.innerHTML = '';
        userDB.accounts.forEach(a => { if(a.name) dl.innerHTML += `<option value="${a.name}">`; });
        const pl = document.getElementById('partnerList');
        pl.innerHTML = '';
        userDB.partnersInfo.forEach(p => { if(p.name) pl.innerHTML += `<option value="${p.name}">`; });
    }

    function getTrialBalances() {
        let accs = {};
        userDB.accounts.forEach(a => { if(a.name) accs[a.name] = { d: 0, c: 0, type: a.type }; });
        userDB.journal.forEach(j => {
            if(accs[j.deb]) accs[j.deb].d += parseFloat(j.v) || 0;
            if(accs[j.cre]) accs[j.cre].c += parseFloat(j.v) || 0;
        });
        let result = [];
        for(let n in accs) {
            let bal = accs[n].d - accs[n].c;
            result.push({ name: n, type: accs[n].type, balance: bal, d: accs[n].d, c: accs[n].c });
        }
        return result;
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    function calculateNetProfit() {
        let bals = getTrialBalances();
        let sum = (type) => bals.filter(a => a.type === type).reduce((s, a) => s + Math.abs(a.balance), 0);
        let mabi = sum('Ù…Ø¨ÙŠØ¹Ø§Øª'), cost = sum('ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª'), mojmal = mabi - cost;
        let otherRev = sum('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰') + sum('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª'), otherExp = sum('Ù…ØµØ±ÙˆÙØ§Øª Ø§Ø®Ø±Ù‰') + sum('Ù…ØµØ±ÙˆÙØ§Øª');
        return mojmal + otherRev - otherExp;
    }

    function render(id) {
        if(id === 'accountsPage') {
            const b = document.getElementById('accountsBody'); b.innerHTML = '';
            userDB.accounts.forEach((a, i) => {
                let typeOpts = ACC_TYPES.map(t => `<option ${a.type==t?'selected':''}>${t}</option>`).join('');
                b.innerHTML += `<tr>
                    <td><input value="${a.name}" ${a.fixed?'readonly':''} onchange="userDB.accounts[${i}].name=this.value;updateDatalists()"></td>
                    <td><select onchange="userDB.accounts[${i}].type=this.value">${typeOpts}</select></td>
                    <td>${a.fixed ? 'ğŸ”’' : `<button class="btn btn-del" onclick="userDB.accounts.splice(${i},1);render('accountsPage')">ğŸ—‘ï¸</button>`}</td></tr>`;
            });
        }
        if(id === 'journalPage') {
            const b = document.getElementById('journalBody'); b.innerHTML = '';
            userDB.journal.forEach((j, i) => {
                let pOpts = `<option value="">-- ØµÙ†Ù --</option>` + userDB.products.map(p => `<option value="${p.name}" ${j.prod===p.name?'selected':''}>${p.name}</option>`).join('');
                b.innerHTML += `<tr>
                    <td><input type="date" value="${j.date||''}" onchange="userDB.journal[${i}].date=this.value"></td>
                    <td><input list="accList" value="${j.deb||''}" onchange="userDB.journal[${i}].deb=this.value"></td>
                    <td><input list="accList" value="${j.cre||''}" onchange="userDB.journal[${i}].cre=this.value"></td>
                    <td><input list="partnerList" value="${j.name||''}" onchange="userDB.journal[${i}].name=this.value"></td>
                    <td><select onchange="updateRowPrice(${i}, this.value)">${pOpts}</select></td>
                    <td><input type="number" id="q${i}" value="${j.q||0}" oninput="validateStock(${i})"></td>
                    <td><input type="number" id="v${i}" value="${j.v||0}" oninput="userDB.journal[${i}].v=this.value"></td>
                    <td><button class="btn btn-save" onclick="render('journalPage')">ğŸ’¾</button> <button class="btn btn-del" onclick="userDB.journal.splice(${i},1);render('journalPage')">ğŸ—‘ï¸</button></td></tr>`;
            });
        }
        if(id === 'partnersPage') {
            const b = document.getElementById('partnersBody'); b.innerHTML = '';
            let pCalc = {};
            userDB.journal.forEach(j => {
                if(j.name) {
                    let n = j.name.trim(); if(!pCalc[n]) pCalc[n] = { d: 0, c: 0 };
                    let v = parseFloat(j.v) || 0;
                    if(["Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", "Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†", "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", "Ø§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ†"].includes(j.deb)) pCalc[n].d += v;
                    if(["Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", "Ø§Ù„Ù…Ø¯ÙŠÙ†ÙˆÙ†", "Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†", "Ø§Ù„Ø¯Ø§Ø¦Ù†ÙˆÙ†"].includes(j.cre)) pCalc[n].c += v;
                }
            });
            userDB.partnersInfo.forEach((p, i) => {
                let d = pCalc[p.name] ? pCalc[p.name].d : 0;
                let c = pCalc[p.name] ? pCalc[p.name].c : 0;
                let net = d - c;
                b.innerHTML += `<tr>
                    <td><input value="${p.name}" onchange="userDB.partnersInfo[${i}].name=this.value;updateDatalists()"></td>
                    <td><input value="${p.phone||''}" onchange="userDB.partnersInfo[${i}].phone=this.value"></td>
                    <td><input value="${p.note||''}" onchange="userDB.partnersInfo[${i}].note=this.value"></td>
                    <td style="color:blue">${d}</td><td style="color:orange">${c}</td>
                    <td style="font-weight:bold; color:${net>=0?'green':'red'}">${net}</td>
                    <td><button class="btn btn-del" onclick="userDB.partnersInfo.splice(${i},1);render('partnersPage')">ğŸ—‘ï¸</button></td></tr>`;
            });
        }
        if(id === 'trialPage') {
            const b = document.getElementById('trialBody'); b.innerHTML = '';
            getTrialBalances().forEach(a => {
                b.innerHTML += `<tr><td>${a.name}</td><td>${a.d}</td><td>${a.c}</td><td>${a.balance>0?a.balance:0}</td><td>${a.balance<0?Math.abs(a.balance):0}</td></tr>`;
            });
        }
        if(id === 'incomePage') {
            const b = document.getElementById('incomeBody'); b.innerHTML = '';
            let bals = getTrialBalances();
            let sum = (type) => bals.filter(a => a.type === type).reduce((s, a) => s + Math.abs(a.balance), 0);
            let mabi = sum('Ù…Ø¨ÙŠØ¹Ø§Øª'), cost = sum('ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª'), mojmal = mabi - cost;
            let otherRev = sum('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰') + sum('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª'), otherExp = sum('Ù…ØµØ±ÙˆÙØ§Øª Ø§Ø®Ø±Ù‰') + sum('Ù…ØµØ±ÙˆÙØ§Øª');
            let net = mojmal + otherRev - otherExp;
            b.innerHTML = `<tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</td><td>${mabi}</td></tr><tr><td>(-) ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</td><td>${cost}</td></tr><tr class="total-row"><td>Ù…Ø¬Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­</td><td>${mojmal}</td></tr><tr><td>(+) Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø®Ø±Ù‰</td><td>${otherRev}</td></tr><tr><td>(-) Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰</td><td>${otherExp}</td></tr><tr class="total-row" style="background:#dcfce7"><td>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©</td><td>${net}</td></tr>`;
        }
        if(id === 'balanceSheetPage') {
            let bals = getTrialBalances();
            const ab = document.getElementById('assetsBody'); ab.innerHTML = '';
            const lb = document.getElementById('liabilitiesBody'); lb.innerHTML = '';
            let totalA = 0, totalL = 0;
            bals.forEach(a => {
                if(a.type === 'Ø£ØµÙˆÙ„' && a.balance !== 0) { let val = Math.abs(a.balance); totalA += val; ab.innerHTML += `<tr><td>${a.name}</td><td>${val}</td></tr>`; }
                if(['Ø§Ù„ØªØ²Ø§Ù…Ø§Øª', 'Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©'].includes(a.type) && a.balance !== 0) { let val = Math.abs(a.balance); totalL += val; lb.innerHTML += `<tr><td>${a.name}</td><td>${val}</td></tr>`; }
            });
            // Ø¥Ø¶Ø§ÙØ© ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø¨Ù„ÙˆÙ† Ù…Ù…ÙŠØ²
            let netProfit = calculateNetProfit();
            totalL += netProfit;
            lb.innerHTML += `<tr style="background:#f0fdf4; font-weight:bold; color:var(--success)"><td>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø®Ø³Ø§Ø±Ø©</td><td>${netProfit}</td></tr>`;
            
            ab.innerHTML += `<tr class="total-row"><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</td><td>${totalA}</td></tr>`;
            lb.innerHTML += `<tr class="total-row"><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ… ÙˆØ§Ù„Ù…Ù„ÙƒÙŠØ©</td><td>${totalL}</td></tr>`;
        }
        if(id === 'productsPage') {
            const b = document.getElementById('productsBody'); b.innerHTML = '';
            userDB.products.forEach((p, i) => {
                let current = parseFloat(p.op)||0;
                userDB.journal.forEach(j => { if(j.prod===p.name){ if(j.deb==="Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")current+=parseFloat(j.q); if(j.cre==="Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")current-=parseFloat(j.q); }});
                b.innerHTML += `<tr><td><input value="${p.name||''}" onchange="userDB.products[${i}].name=this.value"></td><td><input type="number" value="${p.price||0}" onchange="userDB.products[${i}].price=this.value"></td><td><input type="number" value="${p.op||0}" onchange="userDB.products[${i}].op=this.value"></td><td>${current}</td><td><button class="btn btn-del" onclick="userDB.products.splice(${i},1);render('productsPage')">ğŸ—‘ï¸</button></td></tr>`;
            });
        }
    }

    function validateStock(i) {
        let j = userDB.journal[i];
        if(j.cre === "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" && j.prod) {
            let product = userDB.products.find(p => p.name === j.prod);
            let current = parseFloat(product.op)||0;
            userDB.journal.forEach((jj, idx) => { if(idx !== i && jj.prod === j.prod) { if(jj.deb === "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†") current += parseFloat(jj.q)||0; if(jj.cre === "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†") current -= parseFloat(jj.q)||0; }});
            if(parseFloat(document.getElementById('q'+i).value) > current) { alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©! Ø§Ù„Ù…ØªØ§Ø­: " + current); document.getElementById('q'+i).value = 0; }
        }
        calcRowVal(i);
    }

    function updateRowPrice(i, pName) {
        const product = userDB.products.find(p => p.name === pName);
        userDB.journal[i].prod = pName;
        if(product) { document.getElementById('v'+i).value = (parseFloat(product.price) || 0) * (parseFloat(document.getElementById('q'+i).value) || 0); userDB.journal[i].v = document.getElementById('v'+i).value; }
    }

    function calcRowVal(i) {
        userDB.journal[i].q = document.getElementById('q'+i).value;
        const product = userDB.products.find(p => p.name === userDB.journal[i].prod);
        if(product) { document.getElementById('v'+i).value = (parseFloat(product.price) || 0) * (parseFloat(userDB.journal[i].q) || 0); userDB.journal[i].v = document.getElementById('v'+i).value; }
    }

    function addAcc() { userDB.accounts.push({name:'', type:'Ø£ØµÙˆÙ„', fixed: false}); render('accountsPage'); }
    function addJ() { userDB.journal.push({date: new Date().toISOString().split('T')[0], q:0, v:0, deb:'', cre:'', name:'', prod:''}); render('journalPage'); }
    function addP() { userDB.products.push({name:'', price:0, op:0}); render('productsPage'); }
    function addPartnerInfo() { userDB.partnersInfo.push({name:'', phone:'', note:''}); render('partnersPage'); }
</script>
</body>
</html>
