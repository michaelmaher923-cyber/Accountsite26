<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --main: #1e293b; --accent: #0284c7; --bg: #f8fafc; --white: #ffffff; --danger: #be123c; --success: #059669; --blue-row: #d1e9ff; --green-row: #d1fadc; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; color: #334155; }
        header { background: var(--main); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .logo-img { width: 40px; height: 40px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .page { display: none; padding: 25px; }
        .page.active { display: block; }
        .table-container { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f5f9; padding: 12px; border: 1px solid #e2e8f0; font-size: 13px; color: var(--main); }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        input, select { width: 92%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 14px; }
        input[readonly] { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-ins { background: var(--success); color: white; padding: 5px 10px; font-size: 12px; margin-left: 2px; }
        .btn-add { background: var(--main); color: white; margin-bottom: 15px; }
        .btn-excel { background: #166534; color: white; margin-right: 5px; }
        .btn-import { background: #ea580c; color: white; margin-right: 5px; }
        .search-container { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        .search-input { width: 300px; padding: 8px; border: 2px solid var(--accent); border-radius: 6px; }
        .highlight { background-color: #fef08a !important; transition: 0.3s; }
        .row-blue { background-color: var(--blue-row) !important; }
        .row-green { background-color: var(--green-row) !important; }
        .nav-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.3s; }
        .card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .auth-box { max-width: 400px; margin: 80px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; }
        .tab { flex: 1; padding: 10px; cursor: pointer; font-weight: bold; color: #94a3b8; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        #loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .total-row { background: #f8fafc; font-weight: bold; }
    </style>
</head>
<body>
<div id="loader"><b>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</b></div>
<div id="authScreen" class="auth-box">
    <div class="logo-img" style="margin: 0 auto 20px; width: 60px; height: 60px; font-size: 30px;">ğŸ“ˆ</div>
    <div class="tabs">
        <div id="loginTab" class="tab active" onclick="switchAuth(true)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div id="registerTab" class="tab" onclick="switchAuth(false)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
    </div>
    <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="margin-bottom:15px; width:100%;">
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom:15px; width:100%;">
    
    <input type="text" id="verifyKey" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ" style="margin-bottom:5px; width:100%; border: 2px solid #ea580c; background: #fff7ed;">
    
    <p style="font-size: 11px; color: var(--danger); margin-bottom: 10px;">* ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</p>
    <button class="btn btn-save" style="width:100%" onclick="processAuth()">Ø¯Ø®ÙˆÙ„</button>
</div>
<div id="appScreen" style="display:none;">
    <header>
        <div style="display:flex; align-items:center; gap:12px;"><div class="logo-img">ğŸ“‰</div><h2 style="margin:0">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</h2></div>
        <div style="display:flex; align-items:center; gap:15px;">
            <span id="userDisplay" style="font-weight: bold;"></span>
            <button class="btn btn-save" onclick="syncToCloud()" style="background:var(--success)">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn btn-del" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>
    
    <div id="homePage" class="page active">
        <div class="nav-menu">
            <div class="card" onclick="openPage('accountsPage')"><h3>ğŸ“ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3></div>
            <div class="card" onclick="openPage('journalPage')"><h3>ğŸ““ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3></div>
            <div class="card" onclick="openPage('productsPage')"><h3>ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</h3></div>
            <div class="card" onclick="openPage('partnersPage')"><h3>ğŸ¤ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙˆÙ†</h3></div>
            <div class="card" onclick="openPage('trialPage')"><h3>âš–ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</h3></div>
            <div class="card" onclick="openPage('incomePage')" style="background: #f0fdf4;"><h3>ğŸ“Š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h3></div>
            <div class="card" onclick="openPage('balanceSheetPage')" style="background: #eff6ff;"><h3>ğŸ¦ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</h3></div>
            <div class="card" onclick="openPage('guidePage')" style="background: #fffbeb; border: 1px dashed #f59e0b;"><h3>ğŸ“– Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3></div>
        </div>
        <div style="text-align:center; color:#94a3b8; font-size:12px; margin-top:20px;">Ø¥Ø¹Ø¯Ø§Ø¯ : Ø£ Ù…Ø§ÙŠÙƒÙ„ Ù…Ø§Ù‡Ø±</div>
    </div>

    <div id="accountsPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª..." oninput="tableSearch('accountsBody', this.value)">
            <button class="btn btn-excel" onclick="exportData('accounts')">ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn btn-import" onclick="document.getElementById('fileAcc').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <input type="file" id="fileAcc" hidden onchange="importData(this, 'accounts')" accept=".xlsx, .xls">
        </div>
        <div class="table-container"><h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h3><button class="btn btn-add" onclick="addAcc()">+ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button><table><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="accountsBody"></tbody></table></div>
    </div>

    <div id="journalPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©..." oninput="tableSearch('journalBody', this.value)">
            <button class="btn btn-excel" onclick="exportData('journal')">ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn btn-import" onclick="document.getElementById('fileJou').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <input type="file" id="fileJou" hidden onchange="importData(this, 'journal')" accept=".xlsx, .xls">
        </div>
        <div class="table-container">
    <button class="btn btn-add" onclick="addJ()">+ Ù‚ÙŠØ¯ Ø¬Ø¯ÙŠØ¯</button>
    <table>
        <thead>
            <tr>
                <th style="width: 60px;">Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù…Ø¯ÙŠÙ†</th>
                <th>Ø¯Ø§Ø¦Ù†</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
        </thead>
        <tbody id="journalBody"></tbody>
    </table>
</div>
    </div>

    <div id="productsPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù..." oninput="tableSearch('productsBody', this.value)">
            <button class="btn btn-excel" onclick="exportData('products')">ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn btn-import" onclick="document.getElementById('fileProd').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <input type="file" id="fileProd" hidden onchange="importData(this, 'products')" accept=".xlsx, .xls">
        </div>
        <div class="table-container"><h3>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h3><button class="btn btn-add" onclick="addP()">+ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button><table><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>ÙˆØ§Ø±Ø¯</th><th>Ù…Ù†ØµØ±Ù</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="productsBody"></tbody></table></div>
    </div>

    <div id="partnersPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙŠÙ†..." oninput="tableSearch('partnersBody', this.value)">
            <button class="btn btn-excel" onclick="exportData('partners')">ØªØµØ¯ÙŠØ± Excel</button>
            <button class="btn btn-import" onclick="document.getElementById('filePart').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
            <input type="file" id="filePart" hidden onchange="importData(this, 'partners')" accept=".xlsx, .xls">
        </div>
        <div class="table-container"><h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙŠÙ† ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</h3><button class="btn btn-add" onclick="addPartnerInfo()">+ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø§Ù…Ù„</button><table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ù…Ø¯ÙŠÙ† (+)</th><th>Ø¯Ø§Ø¦Ù† (-)</th><th>Ø§Ù„ØµØ§ÙÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="partnersBody"></tbody></table></div>
    </div>

    <div id="statementPage" class="page">
        <button class="btn btn-add" onclick="openPage('partnersPage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <button class="btn btn-excel" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <div class="table-container" id="printArea">
            <h2 id="stName" style="text-align: center; color: var(--main); margin-bottom:5px;">ÙƒØ´Ù Ø­Ø³Ø§Ø¨</h2>
            <p id="stDetails" style="text-align: center; margin-bottom:20px;">ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ Ø¨Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø¢Ø¬Ù„Ø©</p>
            <table>
                <thead>
                    <tr>
                        <th style="width:100px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="width:80px">Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th>
                        <th>Ø§Ù„Ø¨ÙŠØ§Ù† (Ù…Ù„Ø§Ø­Ø¸Ø§Øª)</th>
                        <th style="width:90px">Ù…Ø¯ÙŠÙ† (+)</th>
                        <th style="width:90px">Ø¯Ø§Ø¦Ù† (-)</th>
                        <th style="width:100px">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø§Ø±ÙŠ</th>
                    </tr>
                </thead>
                <tbody id="statementBody"></tbody>
            </table>
        </div>
    </div>
    
    <div id="incomePage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="search-container">
            <button class="btn btn-excel" onclick="exportTableToExcel('incomeBody', 'Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø¯Ø®Ù„')">ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <div class="table-container"><h2 style="text-align: center;">ğŸ“Š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</h2><table><tbody id="incomeBody"></tbody></table></div>
    </div>

    <div id="balanceSheetPage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        <div class="search-container">
            <button class="btn btn-excel" onclick="exportBalanceSheet()">ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <div class="report-grid"><div class="table-container"><h3>Ø§Ù„Ø£ØµÙˆÙ„</h3><table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="assetsBody"></tbody></table></div><div class="table-container"><h3>Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©</h3><table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody id="liabilitiesBody"></tbody></table></div></div>
    </div>

    <div id="guidePage" class="page">
        <button class="btn btn-add" onclick="openPage('homePage')">â¬… Ø±Ø¬ÙˆØ¹</button>
        
        <div class="table-container" style="text-align: right; line-height: 1.8;">
            <h2 style="color: var(--accent); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">ğŸ“– Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</h2>
            <section style="margin-bottom: 20px;">
                <h3 style="color: var(--danger);">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡</h3>
                <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø­Ø§Ù„ Ù†Ø³ÙŠØ§Ù†Ù‡Ù…ØŒ ÙÙŠØ¬Ø¨ Ø£Ù† ØªØªØ£ÙƒØ¯ Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙˆÙ‚Ø¨Ù„ Ø£Ù† ØªØ¶ÙŠÙ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ø¶ØºØ· Ø®Ø±ÙˆØ¬ ÙˆØ¬Ø±Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„ØªØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø¹Ø±ÙØªÙƒ Ù„Ù‡Ù….</p>
            </section>
            <section style="margin-bottom: 20px;">
                <h3>ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙŠÙ† ÙˆØ§Ù„Ù…Ø®Ø²Ù†</h3>
                <ul style="list-style-type: square; padding-right: 20px;">
                    <li><strong>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:</strong> Ø£Ø¶Ù Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ù‡ ÙˆÙ†ÙˆØ¹Ù‡.</li>
                    <li><strong>Ø§Ù„Ù…Ø®Ø²Ù†:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø£Ùˆ ØµÙ†Ù Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "ØµÙ†Ù Ø¬Ø¯ÙŠØ¯".</li>
                    <li><strong>Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ÙˆÙ†:</strong> Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ ÙƒØ´ÙˆÙ Ø§Ù„Ø­Ø³Ø§Ø¨.</li>
                </ul>
            </section>
            <footer style="font-size: 13px; color: #64748b; text-align: center;">
                <p>"Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2026 Ù„Ù„Ø£Ø³ØªØ§Ø°: <strong>Ù…Ø§ÙŠÙƒÙ„ Ù…Ø§Ù‡Ø±</strong>"</p>
            </footer>
        </div>
    </div>
</div>

<datalist id="accList"></datalist>
<datalist id="partnerList"></datalist>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = {
        apiKey: "AIzaSyBP7HP1w4MbOFZWnv7BdpKwDlYjv4VJUTM",
        authDomain: "accountsite26.firebaseapp.com",
        databaseURL: "https://accountsite26-default-rtdb.firebaseio.com",
        projectId: "accountsite26",
        storageBucket: "accountsite26.firebasestorage.app",
        messagingSenderId: "1015795938039",
        appId: "1:1015795938039:web:b625e24fca2c5b231d19f2"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.switchAuth = (isLogin) => {
        document.getElementById('loginTab').classList.toggle('active', isLogin);
        document.getElementById('registerTab').classList.toggle('active', !isLogin);
        document.querySelector('.auth-box .btn-save').innerText = isLogin ? 'Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
    };

    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
    window.processAuth = async () => {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        const inputKey = document.getElementById('verifyKey').value.trim();
        const isLogin = document.getElementById('loginTab').classList.contains('active');

        if(!u || !p || !inputKey) return alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙˆÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚");
        
        document.getElementById('loader').style.display = 'flex';

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø¯ØªÙ‡ ÙÙŠ Firebase
            const configSnap = await get(ref(db, `systemConfig/weeklyCode`));
            const correctKey = configSnap.val();

            if (inputKey != correctKey) {
                document.getElementById('loader').style.display = 'none';
                return alert("âŒ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©");
            }

            localStorage.setItem('user_display_name', u); 
            const safeUser = btoa(unescape(encodeURIComponent(u))).replace(/[/+=]/g, "").toLowerCase().substring(0, 15);
            const email = safeUser + "@maher-system.com";

            if (isLogin) { await signInWithEmailAndPassword(auth, email, p); } 
            else { await createUserWithEmailAndPassword(auth, email, p); alert("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"); }
        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„");
            document.getElementById('loader').style.display = 'none';
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const savedName = localStorage.getItem('user_display_name');
            window.currentUser = savedName || user.email.split('@')[0];
            const snapshot = await get(ref(db, `users/${user.uid}/data`));
            const data = snapshot.exists() ? snapshot.val() : {};
            window.userDB = { accounts: data.accounts || [], journal: data.journal || [], products: data.products || [], partnersInfo: data.partnersInfo || [] };
            startApp();
        }
    });

    window.syncToCloud = async () => {
        if(!auth.currentUser) return;
        document.getElementById('loader').style.display = 'flex';
        try { await set(ref(db, `users/${auth.currentUser.uid}/data`), window.userDB); alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­"); } 
        catch (e) { alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸"); }
        document.getElementById('loader').style.display = 'none';
    };

    window.logout = () => { signOut(auth).then(() => location.reload()); };
    window.db = db; // ØªØµØ¯ÙŠØ± Ø§Ù„Ù€ db Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¢Ø®Ø±
</script>

<script>
    (function(){
        const _0xK3 = ["Ø£ØµÙˆÙ„", "Ø§Ù„ØªØ²Ø§Ù…Ø§Øª", "Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©", "Ù…Ø¨ÙŠØ¹Ø§Øª", "ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª", "Ù…ØµØ±ÙˆÙØ§Øª", "Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", "Ù…Ø®Ø²ÙˆÙ†", "Ù…Ø¯ÙŠÙ†ÙˆÙ†", "Ø¯Ø§Ø¦Ù†ÙˆÙ†", "ØºÙŠØ± Ø°Ù„Ùƒ"];

        window.startApp = function() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('loader').style.display = 'none';
            document.getElementById('userDisplay').innerText = "ğŸ‘¤ " + currentUser;
            updateDatalists(); openPage('homePage');
        };

        window.openPage = function(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            render(id);
        };

        window.tableSearch = function(bodyId, query) {
            const rows = document.getElementById(bodyId).rows;
            const q = query.toLowerCase();
            for (let i = 0; i < rows.length; i++) {
                for (let j = 0; j < rows[i].cells.length; j++) {
                    const cell = rows[i].cells[j];
                    const input = cell.querySelector('input');
                    const text = input ? input.value.toLowerCase() : cell.textContent.toLowerCase();
                    if (q && text.includes(q)) cell.classList.add('highlight');
                    else cell.classList.remove('highlight');
                }
            }
        };

        window.exportData = function(key) {
            let data = (key === 'accounts') ? userDB.accounts : (key === 'journal' ? userDB.journal : (key === 'products' ? userDB.products : userDB.partnersInfo));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `${key}.xlsx`);
        };

        window.importData = function(input, key) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if(key === 'accounts') userDB.accounts = json;
                else if(key === 'journal') userDB.journal = json;
                else if(key === 'products') userDB.products = json;
                else if(key === 'partners') userDB.partnersInfo = json;
                render(key + 'Page'); updateDatalists(); alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        window.exportTableToExcel = (id, name) => { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById(id)), `${name}.xlsx`); };

        window.updateDatalists = function() {
            document.getElementById('accList').innerHTML = userDB.accounts.map(a => `<option value="${a.name}">`).join('');
            document.getElementById('partnerList').innerHTML = userDB.partnersInfo.map(p => `<option value="${p.name}">`).join('');
        };

        window.getTrialBalances = function(fromDate = null, toDate = null) {
            let accs = {};
            userDB.accounts.forEach(a => { if(a.name) accs[a.name] = { d: 0, c: 0, type: a.type }; });
            userDB.journal.forEach(j => {
                if (fromDate && j.date < fromDate) return;
                if (toDate && j.date > toDate) return;
                if(accs[j.deb]) accs[j.deb].d += parseFloat(j.v) || 0;
                if(accs[j.cre]) accs[j.cre].c += parseFloat(j.v) || 0;
            });
            return Object.keys(accs).map(n => ({ name: n, type: accs[n].type, balance: accs[n].d - accs[n].c, d: accs[n].d, c: accs[n].c }));
        };

        window.calculateNetProfit = function(f = null, t = null) {
            let b = getTrialBalances(f, t);
            let s = (type) => b.filter(a => a.type === type).reduce((x, a) => x + Math.abs(a.balance), 0);
            return (s('Ù…Ø¨ÙŠØ¹Ø§Øª') - s('ØªÙƒÙ„ÙØ© Ù…Ø¨ÙŠØ¹Ø§Øª')) + s('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª') - s('Ù…ØµØ±ÙˆÙØ§Øª');
        };

        window.insertRow = function(target, index) {
            let obj = target === 'acc' ? {name:'', type:'Ø£ØµÙˆÙ„'} : (target === 'jou' ? {ref:'', date: new Date().toISOString().split('T')[0], q:0, v:0, deb:'', cre:'', name:'', prod:'', note:'', isBlue: false, showExtra: false} : (target === 'prod' ? {name:'', price:0} : {name:'', phone:'', note:''}));
            let list = target === 'acc' ? userDB.accounts : (target === 'jou' ? userDB.journal : (target === 'prod' ? userDB.products : userDB.partnersInfo));
            list.splice(index + 1, 0, obj); render(document.querySelector('.page.active').id);
        };

        window.render = function(id) {
            if(id === 'accountsPage') {
                const b = document.getElementById('accountsBody'); b.innerHTML = '';
                userDB.accounts.forEach((a, i) => {
                    let o = _0xK3.map(t => `<option ${a.type==t?'selected':''}>${t}</option>`).join('');
                    b.innerHTML += `<tr><td><input value="${a.name||''}" onchange="userDB.accounts[${i}].name=this.value;updateDatalists()"></td><td><select onchange="userDB.accounts[${i}].type=this.value">${o}</select></td><td><button class="btn btn-ins" onclick="insertRow('acc', ${i})">â•</button><button class="btn btn-del" onclick="userDB.accounts.splice(${i},1);render('accountsPage')">ğŸ—‘ï¸</button></td></tr>`;
                });
            }
            if(id === 'journalPage') {
                const b = document.getElementById('journalBody'); b.innerHTML = '';
                let colorCounter = 0; 
                userDB.journal.forEach((j, i) => {
                    let rowClass = j.isBlue ? ((++colorCounter % 2 !== 0) ? 'row-blue' : 'row-green') : '';
                    let extraStyle = j.showExtra ? 'table-row' : 'none';
                    let pO = `<option value="">-- ØµÙ†Ù --</option>` + userDB.products.map(p => `<option value="${p.name}" ${j.prod===p.name?'selected':''}>${p.name}</option>`).join('');
                    b.innerHTML += `<tr class="${rowClass}">
                        <td><input value="${j.ref||''}" onchange="userDB.journal[${i}].ref=this.value"></td>
                        <td><input type="date" value="${j.date||''}" onchange="userDB.journal[${i}].date=this.value"></td>
                        <td><input list="accList" value="${j.deb||''}" onchange="userDB.journal[${i}].deb=this.value"></td>
                        <td><input list="accList" value="${j.cre||''}" onchange="userDB.journal[${i}].cre=this.value"></td>
                        <td><input list="partnerList" value="${j.name||''}" onchange="userDB.journal[${i}].name=this.value"></td>
                        <td><input type="number" id="v${i}" value="${j.v||0}" oninput="userDB.journal[${i}].v=this.value"></td>
                        <td><input value="${j.note||''}" onchange="userDB.journal[${i}].note=this.value"></td>
                        <td style="white-space:nowrap">
                            <button onclick="userDB.journal[${i}].showExtra=!userDB.journal[${i}].showExtra;render('journalPage')">ğŸ“¦</button>
                            <button onclick="userDB.journal[${i}].isBlue=!userDB.journal[${i}].isBlue;render('journalPage')">ğŸ¨</button>
                            <button class="btn btn-ins" onclick="insertRow('jou', ${i})">â•</button>
                            <button class="btn btn-del" onclick="userDB.journal.splice(${i},1);render('journalPage')">ğŸ—‘ï¸</button>
                        </td></tr>
                        <tr class="${rowClass}" style="display:${extraStyle};"><td colspan="3">Ø§Ù„ØµÙ†Ù: <select onchange="updateRowPrice(${i}, this.value)">${pO}</select></td><td colspan="2">Ø§Ù„Ø³Ø¹Ø±: <input type="number" id="p${i}" value="${j.unitPrice || 0}" oninput="calcRowVal(${i})"></td><td colspan="3">Ø§Ù„ÙƒÙ…ÙŠØ©: <input type="number" id="q${i}" value="${j.q||0}" oninput="calcRowVal(${i})"></td></tr>`;
                });
            }
            if(id === 'partnersPage') {
                const b = document.getElementById('partnersBody'); b.innerHTML = '';
                userDB.partnersInfo.forEach((p, i) => {
                    b.innerHTML += `<tr><td><input value="${p.name||''}" onchange="userDB.partnersInfo[${i}].name=this.value"></td><td><input value="${p.phone||''}"></td><td><input value="${p.note||''}"></td><td>-</td><td>-</td><td>-</td><td><button class="btn btn-del" onclick="userDB.partnersInfo.splice(${i},1);render('partnersPage')">ğŸ—‘ï¸</button></td></tr>`;
                });
            }
        };

        window.updateRowPrice = function(i, n) {
            const p = userDB.products.find(x => x.name === n);
            userDB.journal[i].prod = n;
            if(p) { document.getElementById('p'+i).value = p.price; userDB.journal[i].unitPrice = p.price; calcRowVal(i); }
        };

        window.calcRowVal = function(i) {
            let q = document.getElementById('q'+i).value || 0, p = document.getElementById('p'+i).value || 0;
            userDB.journal[i].q = q; userDB.journal[i].unitPrice = p;
            document.getElementById('v'+i).value = q * p; userDB.journal[i].v = q * p;
        };

        window.addAcc = () => { userDB.accounts.push({name:'', type:'Ø£ØµÙˆÙ„'}); render('accountsPage'); };
        window.addJ = () => { userDB.journal.push({ref:'', date: new Date().toISOString().split('T')[0], q:0, v:0, deb:'', cre:'', name:'', prod:'', note:'', isBlue: false, showExtra: false}); render('journalPage'); };
        window.addP = () => { userDB.products.push({name:'', price:0}); render('productsPage'); };
        window.addPartnerInfo = () => { userDB.partnersInfo.push({name:'', phone:'', note:''}); render('partnersPage'); };
    })();
</script>
</body>
</html>
